<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Table with Element UI</title>
    <!-- 引入Element UI的CSS文件 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- 引入Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- 引入Element UI JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 引入Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入 ECharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.0.2/echarts.min.js"></script>

    <style>
        img {
            height: 20px;
            width: 20px;
            vertical-align: middle;
        }

        .positive {
            color: #da2e21;
        }

        .negative {
            color: #089554;
        }

        .price-block {
            display: inline-block;
            /* 保持inline-block以适应span元素 */
            width: 80px;
            /* 设置固定宽度 */
            height: 30px;
            /* 设置固定高度 */
            background-color: #f5f5f5;
            /* 设置背景颜色 */
            padding: 4px;
            /* 可选：添加内边距 */
            border-radius: 5px;
            /* 可选：添加圆角 */
            font-size: 12px;
        }

        .rowsPerPageSelect {
            width: 70px;
        }

        .searchQueryCoin {
            width: 200px;
        }



        .table-wrapper {
            height: 580px;
            padding-left: 0px;
            padding-right: 0px;
            border: 1px solid #e0e0e0;
        }

        .el-table {
            width: 870px;
            height: 580px;
        }

        .el-table__header-wrapper {
            top: 0;
            z-index: 2;
        }

        .el-table__body-wrapper {
            overflow-y: auto;
            width: 870px;
            max-height: 470px;
            /* Adjust the max-height as needed */
        }

        .mode_CryptoTable {
            width: 870px;
            height: 780px;
            float: left;
        }

        .el-timeline-item {
            padding: 0;
        }

        .tweetscardjump {
            cursor: pointer;
            margin-top: 0px;
            margin-bottom: 0px;
            font-size: 12px;
        }

        .mode_tweet_title {
            margin-top: 40px;
            height: 360px;
            width: 360px;
            /* height: 380px;
            position: fixed;
            bottom: 13px; */
            border-radius: 10px;
            margin-left: 20px;
            background-color: #fff;
        }

        .box-card .header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .box-card .button {
            float: right;
            padding: 3px 0;
            background: none;
            border: none;
            color: #409EFF;
            cursor: pointer;
        }

        .box-card .button:hover {
            color: #66b1ff;
        }

        .box-card {
            width: 360px;
            border: 1px solid #ebeef5;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            background-color: #fff;
            height: 100%;
        }

        .el-card__body {
            padding: 0;
        }

        .el-timeline-item__wrapper {
            padding-left: 15px;
        }

        .el-timeline-item__timestamp.is-top {
            margin-bottom: 5px;
            font-size: 10px;
        }

        .el-timeline {
            padding-left: 0px;
        }

        #echarts {
            width: 100%;
            height: 300px;
        }

        .mode_carousel {
            margin-left: 20px;
            width: 360px;
            height: 300px;
            /* position: fixed;
            top: 10px;
            right: 10px; */
            border: 1px solid #111f40;
            border-radius: 10px;
            color: #fff;
            background: #262836;

        }

        .content-right {
            width: 360px;
            /* height: 900px; */
            padding-left: 0px;
            float: left;
            background-color: transparent;
        }

        .echatsHead {
            width: 100%;
            color: #fff;
            height: 30px;
            margin-left: 20px;
        }

        .tipsButton {
            display: inline-block;
            position: relative;
            padding: 3px 0;
            background: none;
            border: none;
            color: #409EFF;
            cursor: pointer;
            margin-left: 95px;
            z-index: 2;
            /* 按钮置于遮罩层上方 */
        }

        .tipsButtonFGI {
            display: inline-block;
            position: relative;
            padding: 3px 0;
            background: none;
            border: none;
            color: #409EFF;
            cursor: pointer;
            margin-left: 120px;
            z-index: 2;
            /* 按钮置于遮罩层上方 */
        }

        .tipsButtonETF {
            display: inline-block;
            position: relative;
            padding: 3px 0;
            background: none;
            border: none;
            color: #409EFF;
            cursor: pointer;
            margin-left: 75px;
            z-index: 2;
            /* 按钮置于遮罩层上方 */
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            /* 遮罩层置于按钮下方 */
        }

        .overlayContent {
            background: transparent;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            z-index: 3;
            /* 遮罩层内容置于按钮上方 */
        }

        .carouselmain {
            height: 300px;
            width: 360px;
            border-top: 2px solid #fff;
        }
    </style>
</head>

<body>


    <div id="app">
        //market表格相关代码
        <div class="mode_CryptoTable">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                <span>marketCap:</span>
                <el-select v-model="rowsPerPage" placeholder="Select number of rows" class="rowsPerPageSelect">
                    <el-option v-for="item in rowOptions" :key="item" :label="item" :value="item"></el-option>
                </el-select>
                <el-input v-model="searchQuery" placeholder="Search by Coin" class="searchQueryCoin"></el-input>
            </div>
            <div class="table-wrapper">
                <el-table :data="paginatedCoins" style="width: 100%" @sort-change="sortData"
                    class="paginatedCoinsTable">
                    <el-table-column prop="no" label="No" width="50" sortable="custom"></el-table-column>
                    <el-table-column label="Coin" width="100">
                        <template slot-scope="scope">
                            <img :src="scope.row.imageUrl" alt="coin image">
                            {{ scope.row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column prop="fullName" label="Name" sortable="custom"></el-table-column>
                    <el-table-column prop="price" label="Price" sortable="custom">
                        <template slot-scope="scope">
                            <span class="price-block" :style="scope.row.priceCellStyle">
                                {{ scope.row.price }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="volume24h" label="24H Volume" sortable="custom"></el-table-column>
                    <el-table-column prop="change24h" label="24H Change" sortable="custom">
                        <template slot-scope="scope">
                            <span :class="scope.row.change24h >= 0 ? 'positive' : 'negative'">
                                {{ scope.row.change24h }}%
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="changePctHour" label="CHANGEPCTHOUR" sortable="custom">
                        <template slot-scope="scope">
                            <span :class="scope.row.changePctHour >= 0 ? 'positive' : 'negative'">
                                {{ scope.row.changePctHour !== null ? scope.row.changePctHour + '%' : '-' }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="changePctDay" label="CHANGEPCTDAY" sortable="custom">
                        <template slot-scope="scope">
                            <span :class="scope.row.changePctDay >= 0 ? 'positive' : 'negative'">
                                {{ scope.row.changePctDay !== null ? scope.row.changePctDay + '%' : '-' }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="marketCap" label="MKTCAP" sortable="custom"></el-table-column>
                    <el-table-column prop="circulatingSupply" label="CIRCULATINGSUPPLY"
                        sortable="custom"></el-table-column>
                </el-table>
            </div>
        </div>
        //页面右侧区域中的内容
        <div class="content-right">
            <!-- carousel -->

            //页面右上方的轮播图《echarts图表》
            <div class="mode_carousel">
                <el-carousel :autoplay="false" indicator-position="outside">
                    <el-carousel-item v-for="item in 3" :key="item">
                        <div v-if="item === 1" style="height: 300px;">
                            <span class="echatsHead">ETH (Ethereum) - Staking Ratio</span>
                            <button class="tipsButton" @click="toggleOverlayETHtips">Tips</button>
                            <div id="echatsETH" class="carouselmain"></div>
                            <!-- 遮罩 -->
                            <div v-if="showOverlayETH" class="overlay">
                                <div class="overlayContent">
                                    <p>The ETH staking ratio shows the percentage of Ethereum (ETH) staked in Ethereum
                                        2.0.
                                        A high ratio
                                        means more security but less ETH for trading, while a low ratio means more ETH
                                        for
                                        trading but less
                                        security. It indicates the community's commitment to Ethereum 2.0.</p>
                                </div>
                            </div>
                        </div>
                        <div v-else-if="item === 2" style="height: 300px;">
                            <span class="echatsHead">Fear and Greed Index (FGI)</span>
                            <button class="tipsButtonFGI" @click="toggleOverlayFGItips">Tips</button>
                            <div id="fearGreedChart" class="carouselmain"></div>
                            <!-- 遮罩 -->
                            <div v-if="showOverlayFGI" class="overlay">
                                <div class="overlayContent">
                                    <p>The crypto market is driven by emotions, with people buying out of FOMO and
                                        selling
                                        in panic. The
                                        Fear and Greed Index helps you avoid these reactions. Extreme fear may signal a
                                        buying opportunity,
                                        while extreme greed suggests a market correction is coming. </p>
                                </div>
                            </div>
                        </div>
                        <div v-else style="height: 300px;">
                            <span class="echatsHead">Total Bitcoin Spot ETF Net Inflow</span>
                            <button class="tipsButtonETF" @click="toggleOverlayETFtips">Tips</button>
                            <div id="echartsETF" class="carouselmain"></div>
                            <!-- 遮罩 -->
                            <div v-if="showOverlayETF" class="overlay">
                                <div class="overlayContent">
                                    <p>This chart shows three indicators for the Bitcoin spot ETF: Daily Net Inflow,
                                        Total
                                        Net Assets, and
                                        Bitcoin Price.
                                        The horizontal axis shows dates, and the vertical axis shows values. Daily Net
                                        Inflow is red
                                        (outflows) and green
                                        (inflows) bars. Total Net Assets and Bitcoin Price are line charts.
                                        Daily Net Inflow is the net money into Bitcoin ETFs each day; Total Net Assets
                                        is
                                        the total value of
                                        ETF assets.</p>
                                </div>
                            </div>
                        </div>
                    </el-carousel-item>
                </el-carousel>
            </div>

            //页面右下角的表格《显示最新爬取的7条推特信息，点击more按钮跳转到对应kol-flow页面》
            <!-- kol -->
            <div class="mode_tweet_title">
                <div class="box-card">
                    <div class="header clearfix">
                        <span>HOT KOL</span>
                        <button class="button" @click="handleMoreClick">More</button>
                    </div>
                    <div>
                        <div class="block" style="margin-bottom: 20px; overflow-y:auto">
                            <el-timeline v-if="!loading && tweets.length">
                                <el-timeline-item v-for="tweet in tweets" :key="tweet.create_time"
                                    :timestamp="tweet.create_time" placement="top">
                                    <el-card class="tweetscard">
                                        <h4 class="tweetscardjump" @click="openUrl(tweet.tweet_url)">{{
                                            truncate(tweet.tweet_title, 40) }}</h4>
                                    </el-card>
                                </el-timeline-item>
                            </el-timeline>
                            <p v-if="loading">loading...</p>
                            <p v-if="!loading && !tweets.length">No data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <script>


        new Vue({
            el: '#app',
            data() {
                return {
                    coins: [],
                    searchQuery: '',
                    sortKey: '',
                    sortOrder: '',
                    socket: null,
                    previousPrice: {}, // 存储前一个价格
                    rowsPerPage: 50,  // Default number of rows per page
                    rowOptions: [50, 100],  // Options for number of rows per page
                    tweets: [],
                    loading: false,
                    limit: 6,
                    showOverlayETH: false,
                    showOverlayFGI: false,
                    showOverlayETF: false,
                };
            },
            //created 方法是一个生命周期钩子函数，一个 vue 实例被生成后会调用这个函数
            created() {
                // this.fetchTweets();
                this.fetchTweetsFromArray();
                this.$nextTick(() => {
                    this.initEChartsETF();
                    this.initEChartsfearGreed();
                    this.initEChartsETH();
                });
            },
            //表示Vue实例已经被挂载到DOM元素上后执行的函数
            mounted() {
                this.$nextTick(() => {
                    this.initEChartsETF();
                    this.initEChartsfearGreed();
                    this.initEChartsETH();
                });
                this.fetchInitialData();
                setInterval(() => {
                    this.updateData();
                    // console.log("++++++++++++++++++++++")
                }, 30000); // 每30秒调用一次updateData方法
            },
            // computed 函数在组件实例中函数式声明，只要该计算属性依赖的响应式变量发生变化，它就会自动更新
            computed: {
                filteredCoins() {
                    return this.coins.filter(coin =>
                        coin.name.toLowerCase().includes(this.searchQuery.toLowerCase())
                    );
                },
                paginatedCoins() {
                    return this.filteredCoins.slice(0, this.rowsPerPage);
                }
            },
            //Vue组件的`methods`选项允许我们定义一系列可复用的函数，这些函数可以直接在模板中触发，或者在组件的其他地方（如事件处理、计算属性等）被调用
            methods: {
                toggleOverlayETHtips() {
                    this.showOverlayETH = !this.showOverlayETH;
                },
                toggleOverlayETFtips() {
                    this.showOverlayETF = !this.showOverlayETF;
                },
                toggleOverlayFGItips() {
                    this.showOverlayFGI = !this.showOverlayFGI;
                },
                // echatsETH
                initEChartsETH() {
                    // Function to generate dates
                    function generateDates(start, end) {
                        var dateArray = [];
                        var currentDate = new Date(start);
                        var endDate = new Date(end);
                        while (currentDate <= endDate) {
                            dateArray.push(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        return dateArray;
                    }
                    // Generate dates from 2024/6/1 to 2024/7/1
                    var dates = generateDates('2024-06-01', '2024-07-01');
                    // Example data for one month
                    var stakingData = [
                        0.7, 0.7, 0.6, 0.7, 0.8, 0.9, 0.7, 0.8, 0.4, 0.6,
                        0.7, 0.8, 0.7, 0.4, 0.6, 0.7, 0.8, 0.9, 0.8, 0.4,
                        0.7, 0.6, 0.7, 0.8, 0.9, 0.7, 0.4, 0.6, 0.7, 0.8, 0.9
                    ];
                    var nonStakingData = [
                        0.3, 0.3, 0.4, 0.3, 0.2, 0.1, 0.3, 0.2, 0.6, 0.4,
                        0.3, 0.2, 0.3, 0.6, 0.4, 0.3, 0.2, 0.1, 0.2, 0.6,
                        0.3, 0.4, 0.3, 0.2, 0.1, 0.3, 0.6, 0.4, 0.3, 0.2, 0.1
                    ];

                    // Initialize the chart
                    var chart = echarts.init(document.getElementById('echatsETH'));

                    // Define the option object
                    var option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        grid: {
                            top: '5%',
                            left: '8%',
                            right: '5%',
                        },
                        xAxis: [
                            {
                                type: 'category',
                                data: dates,
                                axisLabel: {
                                    color: '#ffffff'
                                }
                            }
                        ],
                        yAxis: [
                            {
                                type: 'value',
                                axisLabel: {
                                    color: '#ffffff'
                                }
                            }
                        ],
                        series: [

                            {
                                name: 'Non-Staking Ratio',
                                type: 'bar',
                                stack: 'Ad',
                                barWidth: '100%', //柱子宽度

                                barGap: '0%',
                                emphasis: {
                                    focus: 'series'
                                },
                                itemStyle: {
                                    color: '#e5e5e5'
                                },
                                data: nonStakingData
                            },
                            {
                                name: 'Staking',
                                type: 'bar',
                                stack: 'Ad',
                                barWidth: '100%', //柱子宽度
                                barGap: '0%',//柱边距
                                emphasis: {
                                    focus: 'series'
                                },
                                itemStyle: {
                                    color: '#4d67bf'
                                },
                                data: stakingData
                            }
                        ]
                    };
                    chart.setOption(option);
                },
                // echatsfearGreed
                initEChartsfearGreed() {
                    var fearGreedChartDom = document.getElementById('fearGreedChart');
                    var fearGreedChart = echarts.init(fearGreedChartDom);
                    var fearGreedData = [30, 40, 50, 45, 60, 55];
                    var fearGreedColors = fearGreedData.map(function (value) {
                        var ratio = (value - 50) / 50;
                        if (ratio < 0) {
                            return 'rgb(255,' + Math.round((1 + ratio) * 255) + ',0)';
                        } else {
                            return 'rgb(' + Math.round((1 - ratio) * 255) + ',255,0)';
                        }
                    });

                    var fearGreedOption = {

                        tooltip: {
                            trigger: 'axis'
                        },
                        grid: {
                            top: '10%',
                            left: '8%',
                            right: '5%',
                        },
                        xAxis: {
                            data: ['2023-01', '2023-02', '2023-03', '2023-04', '2023-05', '2023-06'],
                            axisLabel: {
                                color: '#ffffff'
                            }
                        },
                        yAxis: {
                            show: false, // 不显示y轴
                            splitLine: false,
                            axisLabel: {
                                color: '#ffffff'
                            }
                        },

                        series: [
                            {
                                name: 'Crypto Fear & Greed Index',
                                type: 'line',
                                data: fearGreedData,
                                smooth: true,
                                itemStyle: {
                                    color: function (params) {
                                        return fearGreedColors[params.dataIndex];
                                    }
                                },
                                smooth: true,  // 使折线更加平滑
                                showSymbol: false,  // 隐藏节点符号
                                lineStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                        { offset: 0, color: 'red' },
                                        { offset: 0.5, color: 'yellow' },
                                        { offset: 1, color: 'green' }
                                    ])
                                },
                            }
                        ]
                    };
                    fearGreedOption && fearGreedChart.setOption(fearGreedOption);
                },
                // echatsETF
                initEChartsETF() {
                    var chartDom = document.getElementById('echartsETF');
                    var myChart = echarts.init(chartDom);

                    function generateDates(start, end) {
                        var dateArray = [];
                        var currentDate = new Date(start);
                        var endDate = new Date(end);
                        while (currentDate <= endDate) {
                            dateArray.push(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                        return dateArray;
                    }

                    var dates = generateDates('2024-06-01', '2024-07-01');

                    var option = {
                        tooltip: {
                            trigger: 'axis',
                        },
                        // legend: {
                        //     data: ['Daily Total Net Inflow', 'Total Net Assets']
                        // },
                        grid: {
                            top: '10%',
                            left: '15%',
                            right: '15%'
                        },
                        xAxis: [
                            {
                                type: 'category',
                                data: dates,
                                axisLabel: {
                                    color: '#ffffff'
                                }
                            }
                        ],
                        yAxis: [
                            {
                                type: 'value',
                                // name: 'Daily Total Net Inflow',
                                min: -400,
                                max: 400,
                                interval: 200,
                                splitLine: false,
                                axisLabel: {
                                    color: '#ffffff',
                                    formatter: '{value}M '
                                }
                            },
                            {
                                type: 'value',
                                min: 0,
                                interval: 10,
                                axisLabel: {
                                    color: '#ffffff',
                                    formatter: '{value}B '
                                }
                            }
                        ],
                        series: [
                            {
                                name: 'Daily Total Net Inflow',
                                type: 'bar',
                                barWidth: '80%', //柱子宽度
                                barGap: '10%', //柱边距
                                itemStyle: {
                                    color: function (params) {
                                        return params.value >= 0 ? 'green' : 'red';
                                    }
                                },
                                tooltip: {
                                    valueFormatter: function (value) {
                                        return value;
                                    }
                                },
                                data: [
                                    2.6, -5.9, 9.0, -26.4, -28.7, 70.7, 175.6, -182.2, -98.7, 18.8, 6.0, 2.3,
                                    21.6, -51.9, 9.0, -26.4, -218.7, 70.7, 175.6, -82.2, -48.7, 18.8, 26.0, 12.3,
                                    2.6, -15.9, 9.0, -26.4, -128.7, 70.7,
                                ]
                            },
                            {
                                name: 'Total Net Assets',
                                type: 'line',
                                itemStyle: {
                                    normal: {
                                        color: "#1c1c1c",
                                        lineStyle: {
                                            color: "#1c1c1c"
                                        }
                                    }
                                },
                                yAxisIndex: 1,
                                smooth: true,  // 使折线更加平滑
                                showSymbol: false,  // 隐藏节点符号
                                tooltip: {
                                    valueFormatter: function (value) {
                                        return value + 'B';
                                    }
                                },
                                data: [
                                    55.0, 54.2, 53.3, 52.5, 61.3, 71.2, 50.3, 53.4, 66.0, 64.5, 60.0, 60.2,
                                    55.0, 54.2, 53.3, 52.5, 61.3, 71.2, 50.3, 53.4, 66.0, 64.5, 60.0, 60.2,
                                    55.0, 54.2, 53.3, 52.5, 53.3, 52.5,
                                ]
                            }
                        ]
                    };

                    myChart.setOption(option);
                },
                async fetchTweetsFromArray() {
                    this.loading = true;
                    try {
                        await this.fetchTweets();
                    } catch (error) {
                        console.error('Error processing the tweets:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                fetchTweets() {
                    this.loading = true;
                    fetch(`https://blastai-getjson.zeabur.app/gettweets100?endId=${this.endId}`)
                        .then(response => response.json())
                        .then(data => {
                            let tweetsArray = this.tweets.concat(data.tweets);;
                            this.tweets = tweetsArray.slice(0, this.limit);
                        })
                        .catch(error => console.error('Error fetching the tweets:', error))
                        .finally(() => {
                            this.loading = false;
                        });
                },
                openUrl(url) {
                    window.open(url, '_blank');
                },
                truncate(text, length) {
                    return text.length > length ? text.substring(0, length) + '...' : text;
                },
                handleMoreClick() {
                    // console.log("11111");
                    window.location.href = 'https://www.blastai.xyz/kol-flow';
                },
                //获取市值前100的token的各种信息，返回一个json文件
                async fetchInitialData() {
                    const apiKey = '51ecfdf4527fa8513c278ee17951c008df12d00ad023c31c7e546e85e27ea88d';
                    const url = `https://min-api.cryptocompare.com/data/top/mktcapfull?limit=100&tsym=USD&api_key=${apiKey}`;
                    try {
                        const response = await axios.get(url);
                        this.coins = response.data.Data.map(this.processCoinData);
                        this.initializeWebSocket();
                    } catch (error) {
                        console.error('Error fetching initial data:', error);
                    }
                },
                // vue初始化时，获取市值前100的token对应的表格信息
                processCoinData(coin, index) {
                    const coinInfo = coin.CoinInfo || {};
                    const displayInfo = coin.DISPLAY ? coin.DISPLAY.USD : {};

                    return {
                        no: index + 1,
                        imageUrl: `https://www.cryptocompare.com${coinInfo.ImageUrl || ''}`,
                        name: coinInfo.Name || '-',
                        fullName: coinInfo.FullName || '-',
                        price: displayInfo.PRICE ? this.formatPrice(displayInfo.PRICE) : '-',
                        volume24h: displayInfo.VOLUME24HOURTO ? this.formatVolume24(displayInfo.VOLUME24HOURTO) : '-',
                        change24h: displayInfo.CHANGEPCT24HOUR || '-',
                        changePctHour: displayInfo.CHANGEPCTHOUR || null,
                        changePctDay: displayInfo.CHANGEPCTDAY || null,
                        marketCap: displayInfo.MKTCAP ? this.formatVolume24(displayInfo.MKTCAP) : '-',
                        circulatingSupply: displayInfo.CIRCULATINGSUPPLYMKTCAP ? this.formatVolume24(displayInfo.CIRCULATINGSUPPLYMKTCAP) : '-'
                    };
                },

                //每隔30秒更新一次change24h、changePctHour、changePctDay列对应的信息
                async updateData() {
                    const apiKey = '51ecfdf4527fa8513c278ee17951c008df12d00ad023c31c7e546e85e27ea88d';
                    const url = `https://min-api.cryptocompare.com/data/top/mktcapfull?limit=100&tsym=USD&api_key=${apiKey}`;

                    try {
                        // console.log("Fetching updated data...");
                        const response = await axios.get(url);
                        // console.log("Data received:", response.data);

                        // 更新 coins 数组中的 change24h、changePctHour 和 changePctDay
                        response.data.Data.forEach((message, index) => {
                            const coinIndex = index; // 假设每个币种的索引与数组中的索引对应


                            if (coinIndex !== -1 && coinIndex < this.coins.length) {
                                // console.log("Updating coin:", this.coins[coinIndex].name);

                                const displayInfo = message.DISPLAY ? message.DISPLAY.USD : {};

                                const updatedCoin = {
                                    ...this.coins[coinIndex],
                                    change24h: displayInfo.CHANGEPCT24HOUR !== undefined ? displayInfo.CHANGEPCT24HOUR : '-',
                                    changePctHour: displayInfo.CHANGEPCTHOUR !== undefined ? displayInfo.CHANGEPCTHOUR : '-',
                                    changePctDay: displayInfo.CHANGEPCTDAY !== undefined ? displayInfo.CHANGEPCTDAY : '-'
                                };

                                Vue.set(this.coins, coinIndex, updatedCoin);

                            } else {
                                console.warn(`Coin at index ${coinIndex} not found in the coins array or index out of range.`);
                            }
                        });
                    } catch (error) {
                        console.error('Error fetching updated data:', error);
                    }
                },

                //如果price大于1，保留两位小数；如果price小于1，保留4位小数
                formatPrice(price) {
                    if (typeof price === 'string') {
                        // Remove currency symbol and commas
                        price = parseFloat(price.replace(/[^0-9.-]+/g, ""));
                    }

                    if (price >= 1) {
                        return '$' + price.toFixed(2).replace(/\.?0+$/, '');
                    } else {
                        const significantDigits = 4;
                        const numStr = price.toString();
                        const [, decimal] = numStr.split('.');
                        if (!decimal) return '$' + price.toFixed(significantDigits);
                        const firstNonZero = decimal.split('').findIndex(char => char !== '0');
                        const precision = firstNonZero + significantDigits;
                        return '$' + price.toFixed(precision);
                    }
                },
                //将价格单位换算成T、B、M、K,并保留两位有效数字
                formatVolume24(value) {
                    if (typeof value === 'string') {
                        value = parseFloat(value.replace(/[^0-9.-]+/g, ""));
                    }
                    let formatted;
                    if (value >= 1_000_000_000_000) {
                        formatted = (value / 1_000_000_000_000).toFixed(2) + 'T';
                    } else if (value >= 1_000_000_000) {
                        formatted = (value / 1_000_000_000).toFixed(2) + 'B';
                    } else if (value >= 1_000_000) {
                        formatted = (value / 1_000_000).toFixed(2) + 'M';
                    } else if (value >= 1_000) {
                        formatted = (value / 1_000).toFixed(2) + 'K';
                    } else {
                        formatted = value.toFixed(2);
                    }

                    // Remove trailing zeros and possibly the decimal point
                    formatted = formatted.replace(/\.?0+$/, '');

                    // Add '$' symbol before returning the value
                    return '$' + formatted;
                },
                //websocket的链接、传输和关闭，调用api，订阅前100个token的信息，保证表格数据实时更新
                initializeWebSocket() {
                    this.socket = new WebSocket('wss://streamer.cryptocompare.com/v2?api_key=51ecfdf4527fa8513c278ee17951c008df12d00ad023c31c7e546e85e27ea88d');

                    this.socket.onopen = () => {
                        console.log('WebSocket connected.');
                        const subscriptionMessage = {
                            action: 'SubAdd',
                            subs: this.coins.map(coin => `5~CCCAGG~${coin.name}~USD`)
                        };
                        this.socket.send(JSON.stringify(subscriptionMessage));
                    };

                    this.socket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.TYPE === '5') {
                            this.updateCoinData(message);
                        }
                    };

                    this.socket.onclose = () => {
                        console.log('WebSocket connection closed.');
                    };

                    this.socket.onerror = (error) => {
                        console.error('WebSocket encountered error:', error);
                    };
                },
                //存储前一个price，判断price的升降，如果price升高，背景颜色变为绿色，持续0.5秒；如果price降低，背景颜色变为红色，持续0.5秒
                updateCoinData(message) {
                    // console.log("Received WebSocket message:", message);

                    const coinIndex = this.coins.findIndex(coin => coin.name === message.FROMSYMBOL);

                    if (coinIndex !== -1) {
                        const previousPrice = this.previousPrice[message.FROMSYMBOL] || null;

                        let currentPrice = null;
                        if (message.PRICE !== undefined) {
                            try {
                                const numericPrice = typeof message.PRICE === 'number'
                                    ? message.PRICE
                                    : parseFloat(message.PRICE.replace(/[^0-9.-]+/g, ""));

                                if (!isNaN(numericPrice)) {
                                    currentPrice = this.formatPrice(numericPrice);
                                }
                            } catch (error) {
                                console.error("Error processing price:", error);
                            }
                        }

                        // 更新前一个价格
                        this.previousPrice[message.FROMSYMBOL] = currentPrice;

                        if (previousPrice !== null && currentPrice !== null) {
                            // 根据价格变化设置背景颜色、字体颜色和字体加粗
                            if (currentPrice > previousPrice) {
                                this.coins[coinIndex].priceCellStyle = {
                                    backgroundColor: '#89f5b9',
                                    color: '#fff',
                                    fontWeight: 'bold'
                                };
                                setTimeout(() => {
                                    this.coins[coinIndex].priceCellStyle = {
                                        backgroundColor: '#f5f5f5',
                                        color: '#000',
                                        fontWeight: 'normal'
                                    };
                                }, 500); // 100ms 后再改变样式
                            } else if (currentPrice < previousPrice) {
                                this.coins[coinIndex].priceCellStyle = {
                                    backgroundColor: '#f68e8e',
                                    color: '#fff',
                                    fontWeight: 'bold'
                                };
                                setTimeout(() => {
                                    this.coins[coinIndex].priceCellStyle = {
                                        backgroundColor: '#f5f5f5',
                                        color: '#000',
                                        fontWeight: 'normal'
                                    };
                                }, 500); // 100ms 后再改变样式
                            } else {
                                // 默认样式
                                this.coins[coinIndex].priceCellStyle = {
                                    backgroundColor: '#f5f5f5',
                                    color: '#000',
                                    fontWeight: 'normal'
                                };
                            }
                        }




                        // 更新其他数据
                        const updatedCoin = {
                            ...this.coins[coinIndex],
                            price: currentPrice !== null ? currentPrice : this.coins[coinIndex].price,
                            volume24h: message.VOLUME24HOURTO ? this.formatVolume24(message.VOLUME24HOURTO) : this.coins[coinIndex].volume24h,
                            marketCap: message.CURRENTSUPPLYMKTCAP ? this.formatVolume24(message.CURRENTSUPPLYMKTCAP) : this.coins[coinIndex].marketCap,
                            circulatingSupply: message.CIRCULATINGSUPPLYMKTCAP ? this.formatVolume24(message.CIRCULATINGSUPPLYMKTCAP) : this.coins[coinIndex].circulatingSupply,
                            // change24h: this.coins[coinIndex].change24h || '-',
                            // changePctHour: this.coins[coinIndex].changePctHour || '-',
                            // changePctDay: this.coins[coinIndex].changePctDay || '-'
                        };


                        Vue.set(this.coins, coinIndex, updatedCoin);
                        this.$forceUpdate();
                    } else {
                        console.warn(`Coin ${message.FROMSYMBOL} not found in the coins array.`);
                    }
                },
                //定义排序
                sortData({ prop, order }) {
                    this.sortKey = prop;
                    this.sortOrder = order;
                    this.coins.sort((a, b) => {
                        let result = 0;
                        if (a[prop] < b[prop]) {
                            result = -1;
                        } else if (a[prop] > b[prop]) {
                            result = 1;
                        }
                        return order === 'ascending' ? result : -result;
                    });
                }
            }

        });
    </script>

</body>

</html>